

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>utils.util &mdash; BiaPy  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> BiaPy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Get started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/how_it_works.html">How it works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/select_workflow.html">Select workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/semantic_segmentation.html">Semantic segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/instance_segmentation.html">Instance segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/detection.html">Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/denoising.html">Denoising</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/super_resolution.html">Super-resolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/self_supervision.html">Self-supervision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/classification.html">Classification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/cysto.html">3D Cysto Instance Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/mitochondria.html">2D Mitochondria segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/mitochondria_instance.html">2D Mitochondria instance segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/nucleus.html">3D Nuclei Instance Segmentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../config/main_config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../engine/engine.html">engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models/models.html">models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils/utils.html">utils</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BiaPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>utils.util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for utils.util</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imsave</span><span class="p">,</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">engine.metrics</span> <span class="kn">import</span> <span class="n">jaccard_index_numpy</span><span class="p">,</span> <span class="n">voc_calculation</span><span class="p">,</span> <span class="n">DET_calculation</span>
<span class="kn">from</span> <span class="nn">utils.matching</span> <span class="kn">import</span> <span class="n">_safe_divide</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">f1</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="limit_threads"><a class="viewcode-back" href="../../utils/util.html#utils.util.limit_threads">[docs]</a><span class="k">def</span> <span class="nf">limit_threads</span><span class="p">(</span><span class="n">threads_number</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Limits the number of threads for a python process.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       threads_number : int, optional</span>
<span class="sd">           Number of threads.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Python process limited to </span><span class="si">{}</span><span class="s2"> thread&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">threads_number</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MKL_DYNAMIC&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;FALSE&quot;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NUMEXPR_NUM_THREADS&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;VECLIB_MAXIMUM_THREADS&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span></div>


<div class="viewcode-block" id="set_seed"><a class="viewcode-back" href="../../utils/util.html#utils.util.set_seed">[docs]</a><span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seedValue</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">determinism</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the seed on multiple python modules to obtain results as reproducible as possible.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       seedValue : int, optional</span>
<span class="sd">           Seed value.</span>

<span class="sd">       determinism : bool, optional</span>
<span class="sd">           To force determism.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seedValue</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seedValue</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seedValue</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">seedValue</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">determinism</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_DETERMINISTIC_OPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span></div>


<div class="viewcode-block" id="create_plots"><a class="viewcode-back" href="../../utils/util.html#utils.util.create_plots">[docs]</a><span class="k">def</span> <span class="nf">create_plots</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">chartOutDir</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;jaccard_index&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create loss and main metric plots with the given results.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       results : Keras History object</span>
<span class="sd">           Record of training loss values and metrics values at successive epochs. History object is returned by Keras</span>
<span class="sd">           `fit() &lt;https://keras.io/api/models/model_training_apis/#fit-method&gt;`_ method.</span>

<span class="sd">       job_id : str</span>
<span class="sd">           Jod identifier.</span>

<span class="sd">       chartOutDir : str</span>
<span class="sd">           Path where the charts will be stored into.</span>

<span class="sd">       metric : str, optional</span>
<span class="sd">           Metric used.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       +--------------------------------------------+--------------------------------------------+</span>
<span class="sd">       | .. figure:: ../img/chart_loss.png          | .. figure:: ../img/chart_jaccard_index.png |</span>
<span class="sd">       |   :width: 80%                              |   :width: 80%                              |</span>
<span class="sd">       |   :align: center                           |   :align: center                           |</span>
<span class="sd">       |                                            |                                            |</span>
<span class="sd">       |   Loss values on each epoch                |   Jaccard index values on each epoch       |</span>
<span class="sd">       +--------------------------------------------+--------------------------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating training plots . . .&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># For matplotlib errors in display</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>

    <span class="c1"># Loss</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39; loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Train loss&#39;</span><span class="p">,</span> <span class="s1">&#39;Val. loss&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;_loss.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Metric</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Train metric&#39;</span><span class="p">,</span> <span class="s1">&#39;Val. metric&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">metric</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>


<div class="viewcode-block" id="threshold_plots"><a class="viewcode-back" href="../../utils/util.html#utils.util.threshold_plots">[docs]</a><span class="k">def</span> <span class="nf">threshold_plots</span><span class="p">(</span><span class="n">preds_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">det_eval_ge_path</span><span class="p">,</span> <span class="n">det_eval_path</span><span class="p">,</span> <span class="n">det_bin</span><span class="p">,</span> <span class="n">n_dig</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> <span class="n">char_dir</span><span class="p">,</span>
                    <span class="n">r_val</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a plot with the different metric values binarizing the prediction with different thresholds, from ``0.1``</span>
<span class="sd">       to ``0.9``.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       preds_test : 4D Numpy array</span>
<span class="sd">           Predictions made by the model. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       Y_test : 4D Numpy array</span>
<span class="sd">           Ground truth of the data. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       det_eval_ge_path : str</span>
<span class="sd">           Path where the ground truth is stored for the DET calculation.</span>

<span class="sd">       det_eval_path : str</span>
<span class="sd">           Path where the evaluation of the metric will be done.</span>

<span class="sd">       det_bin : str</span>
<span class="sd">           Path to the DET binary.</span>

<span class="sd">       n_dig : int</span>
<span class="sd">           The number of digits used for encoding temporal indices (e.g. ``3``). Used by the DET calculation binary.</span>

<span class="sd">       job_id : str</span>
<span class="sd">           Id of the job.</span>

<span class="sd">       job_file : str</span>
<span class="sd">           Id and run number of the job.</span>

<span class="sd">       char_dir : str</span>
<span class="sd">           Path to store the charts generated.</span>

<span class="sd">       r_val : float, optional</span>
<span class="sd">           Threshold values to return.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       t_jac : float</span>
<span class="sd">           Value of the Jaccard index when the threshold is ``r_val``.</span>

<span class="sd">       t_voc : float</span>
<span class="sd">           Value of VOC when the threshold is ``r_val``.</span>

<span class="sd">       t_det : float</span>
<span class="sd">           Value of DET when the threshold is ``r_val``.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>

<span class="sd">           jac, voc, det = threshold_plots(</span>
<span class="sd">               preds_test, Y_test, det_eval_ge_path, det_eval_path, det_bin,</span>
<span class="sd">               n_dig, args.job_id, &#39;278_3&#39;, char_dir)</span>

<span class="sd">       Will generate 3 charts, one per each metric: IoU, VOC and DET. In the x axis represents the 9 different</span>
<span class="sd">       thresholds applied, that is: ``0.1, 0.2, 0.3, ..., 0.9``. The y axis is the value of the metric in each chart. For</span>
<span class="sd">       instance, the Jaccard/IoU chart will look like this:</span>

<span class="sd">       .. image:: ../img/278_3_threshold_Jaccard.png</span>
<span class="sd">           :width: 60%</span>
<span class="sd">           :align: center</span>

<span class="sd">       In this example, the best value, ``0.868``, is obtained with a threshold of ``0.4``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">char_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="s2">&quot;t_&quot;</span> <span class="o">+</span> <span class="n">job_file</span><span class="p">)</span>

    <span class="n">t_jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">t_voc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">t_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_val_pos</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)):</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">r_val</span><span class="p">:</span>
            <span class="n">r_val_pos</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

        <span class="c1"># Threshold images</span>
        <span class="n">bin_preds_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds_test</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Metrics (Jaccard + VOC + DET)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculate metrics . . .&quot;</span><span class="p">)</span>
        <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_index_numpy</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">)</span>
        <span class="n">t_voc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">voc_calculation</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">t_det</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DET_calculation</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">,</span> <span class="n">det_eval_ge_path</span><span class="p">,</span> <span class="n">det_eval_path</span><span class="p">,</span> <span class="n">det_bin</span><span class="p">,</span> <span class="n">n_dig</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_jac[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_voc[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_det[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_det</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1"># For matplotlib errors in display</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot Jaccard values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; Jaccard&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_jac</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_Jaccard.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Plot VOC values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; VOC&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_voc</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_VOC.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Plot DET values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_det</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; DET&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_det</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_det</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_DET.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="k">return</span>  <span class="n">t_jac</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">],</span> <span class="n">t_voc</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">],</span> <span class="n">t_det</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">]</span></div>


<div class="viewcode-block" id="save_tif"><a class="viewcode-back" href="../../utils/util.html#utils.util.save_tif">[docs]</a><span class="k">def</span> <span class="nf">save_tif</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save images in the given directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D/5D numpy array</span>
<span class="sd">           Data to save as images. The first dimension must be the number of images. E.g.</span>
<span class="sd">           ``(num_of_images, y, x, channels)`` or ``(num_of_images, z, y, x, channels)``.</span>

<span class="sd">       data_dir : str, optional</span>
<span class="sd">           Path to store X images.</span>

<span class="sd">       filenames : List, optional</span>
<span class="sd">           Filenames that should be used when saving each image.</span>

<span class="sd">       verbose : bool, optional</span>
<span class="sd">            To print saving information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">{}</span><span class="s2"> data as .tif in folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filenames array and length of X have different shapes: </span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>

    <span class="n">_dtype</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
        <span class="n">imsave</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">},</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_tif_pair_discard"><a class="viewcode-back" href="../../utils/util.html#utils.util.save_tif_pair_discard">[docs]</a><span class="k">def</span> <span class="nf">save_tif_pair_discard</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save images in the given directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D/5D numpy array</span>
<span class="sd">           Data to save as images. The first dimension must be the number of images. E.g.</span>
<span class="sd">           ``(num_of_images, y, x, channels)`` or ``(num_of_images, z, y, x, channels)``.</span>

<span class="sd">       Y : 4D/5D numpy array</span>
<span class="sd">           Data mask to save. The first dimension must be the number of images. E.g.</span>
<span class="sd">           ``(num_of_images, y, x, channels)`` or ``(num_of_images, z, y, x, channels)``.</span>

<span class="sd">       data_dir : str, optional</span>
<span class="sd">           Path to store X images.</span>

<span class="sd">       suffix : str, optional</span>
<span class="sd">           Suffix to apply on output directory.</span>

<span class="sd">       filenames : List, optional</span>
<span class="sd">           Filenames that should be used when saving each image.</span>

<span class="sd">       discard : bool, optional</span>
<span class="sd">           Wheter to discard image/mask pairs if the mask has no label information.</span>

<span class="sd">       verbose : bool, optional</span>
<span class="sd">            To print saving information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">{}</span><span class="s2"> data as .tif in folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filenames array and length of X have different shapes: </span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>

    <span class="n">_dtype</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">discard</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
                <span class="n">f2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
                <span class="n">f2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="n">imsave</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">},</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="n">imsave</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">},</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_img"><a class="viewcode-back" href="../../utils/util.html#utils.util.save_img">[docs]</a><span class="k">def</span> <span class="nf">save_img</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save images in the given directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D numpy array, optional</span>
<span class="sd">           Data to save as images. The first dimension must be the number of images. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       data_dir : str, optional</span>
<span class="sd">           Path to store X images.</span>

<span class="sd">       Y : 4D numpy array, optional</span>
<span class="sd">           Masks to save as images. The first dimension must be the number of images. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       scale_mask : bool, optional</span>
<span class="sd">           To allow mask be multiplied by 255.</span>

<span class="sd">       mask_dir : str, optional</span>
<span class="sd">           Path to store Y images.</span>

<span class="sd">       prefix : str, optional</span>
<span class="sd">           Path to store generated charts.</span>

<span class="sd">       filenames : list, optional</span>
<span class="sd">           Filenames that should be used when saving each image. If any provided each image should be named as:</span>
<span class="sd">           ``prefix + &quot;_x_&quot; + image_number + extension`` when ``X.ndim &lt; 4`` and ``prefix + &quot;_x_&quot; + image_number +</span>
<span class="sd">           &quot;_&quot; + slice_numger + extension`` otherwise. E.g. ``prefix_x_000.png`` when ``X.ndim &lt; 4`` or</span>
<span class="sd">           ``prefix_x_000_000.png`` when ``X.ndim &gt;= 4``.  The same applies to ``Y``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="s2">&quot;x_&quot;</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="s2">&quot;y_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_x_&quot;</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_y_&quot;</span>

    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not data_dir provided so no image will be saved!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving images in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">p_x</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">p_x</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not mask_dir provided so no image will be saved!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving images in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">))</span>

        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">scale_mask</span> <span class="k">else</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;_c&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">p_y</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>

                        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;_c&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">p_y</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>

                    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_weight_map"><a class="viewcode-back" href="../../utils/util.html#utils.util.make_weight_map">[docs]</a><span class="k">def</span> <span class="nf">make_weight_map</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a weight map in order to make the U-Net learn better the borders of cells and distinguish individual</span>
<span class="sd">       cells that are tightly packed. These weight maps follow the methodology of the original U-Net paper.</span>

<span class="sd">       Based on `unet/py_files/helpers.py &lt;https://github.com/deepimagej/python4deepimagej/blob/499955a264e1b66c4ed2c014cb139289be0e98a4/unet/py_files/helpers.py&gt;`_.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>

<span class="sd">       label : 3D numpy array</span>
<span class="sd">          Corresponds to a label image. E.g. ``(y, x, channels)``.</span>

<span class="sd">       binary : bool, optional</span>
<span class="sd">          Corresponds to whether or not the labels are binary.</span>

<span class="sd">       w0 : float, optional</span>
<span class="sd">          Controls for the importance of separating tightly associated entities.</span>

<span class="sd">       sigma : int, optional</span>
<span class="sd">          Represents the standard deviation of the Gaussian used for the weight map.</span>

<span class="sd">       Example</span>
<span class="sd">       -------</span>

<span class="sd">       Notice that weight has been defined where the objects are almost touching</span>
<span class="sd">       each other.</span>

<span class="sd">       .. image:: ../img/weight_map.png</span>
<span class="sd">           :width: 650</span>
<span class="sd">           :align: center</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialization.</span>
    <span class="n">lab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">lab_multi</span> <span class="o">=</span> <span class="n">lab</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get shape of label.</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">lab</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>

        <span class="c1"># Converts the label into a binary image with background = 0</span>
        <span class="c1"># and cells = 1.</span>
        <span class="n">lab</span><span class="p">[</span><span class="n">lab</span> <span class="o">==</span> <span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Builds w_c which is the class balancing map. In our case, we want</span>
        <span class="c1"># cells to have weight 2 as they are more important than background</span>
        <span class="c1"># which is assigned weight 1.</span>
        <span class="n">w_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># Converts the labels to have one class per object (cell).</span>
        <span class="n">lab_multi</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Converts the label into a binary image with background = 0.</span>
        <span class="c1"># and cells = 1.</span>
        <span class="n">lab</span><span class="p">[</span><span class="n">lab</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Builds w_c which is the class balancing map. In our case, we want</span>
        <span class="c1"># cells to have weight 2 as they are more important than background</span>
        <span class="c1"># which is assigned weight 1.</span>
        <span class="n">w_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lab_multi</span><span class="p">)</span>

    <span class="n">n_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_comp</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>

    <span class="n">map_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">n_comp</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>

            <span class="c1"># Only keeps current object.</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lab_multi</span> <span class="o">==</span> <span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Invert tmp so that it can have the correct distance.</span>
            <span class="c1"># transform</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="o">~</span><span class="n">tmp</span>

            <span class="c1"># For each pixel, computes the distance transform to</span>
            <span class="c1"># each object.</span>
            <span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">][:][:]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get distance to the closest object (d1) and the distance to the second</span>
        <span class="c1"># object (d2).</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][:][:]</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][:][:]</span>

        <span class="n">map_weight</span> <span class="o">=</span> <span class="n">w0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lab</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span>

    <span class="n">map_weight</span> <span class="o">+=</span> <span class="n">w_c</span>

    <span class="k">return</span> <span class="n">map_weight</span></div>


<div class="viewcode-block" id="do_save_wm"><a class="viewcode-back" href="../../utils/util.html#utils.util.do_save_wm">[docs]</a><span class="k">def</span> <span class="nf">do_save_wm</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the label images, applies the weight-map algorithm and save the weight maps in a folder. Uses</span>
<span class="sd">       internally :meth:`util.make_weight_map`.</span>

<span class="sd">       Based on `deepimagejunet/py_files/helpers.py &lt;https://github.com/deepimagej/python4deepimagej/blob/499955a264e1b66c4ed2c014cb139289be0e98a4/unet/py_files/helpers.py&gt;`_.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       labels : 4D numpy array</span>
<span class="sd">           Corresponds to given label images. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       path : str</span>
<span class="sd">           Refers to the path where the weight maps should be saved.</span>

<span class="sd">       binary : bool, optional</span>
<span class="sd">           Corresponds to whether or not the labels are binary.</span>

<span class="sd">       w0 : float, optional</span>
<span class="sd">           Controls for the importance of separating tightly associated entities.</span>

<span class="sd">       sigma : int, optional</span>
<span class="sd">           Represents the standard deviation of the Gaussian used for the weight</span>
<span class="sd">           map.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Copy labels.</span>
    <span class="n">labels_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># Perform weight maps.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_</span><span class="p">)):</span>
        <span class="n">labels_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_weight_map</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">binary</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels_</span><span class="p">)</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Resize correctly the maps so that it can be used in the model.</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Count number of digits in n. This is important for the number</span>
    <span class="c1"># of leading zeros in the name of the maps.</span>
    <span class="n">n_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># Save path with correct leading zeros.</span>
    <span class="n">path_to_save</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;weight/{b:0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_digits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}.npy&quot;</span>

    <span class="c1"># Saving files as .npy files.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_</span><span class="p">)):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_to_save</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">i</span><span class="p">),</span> <span class="n">labels_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="foreground_percentage"><a class="viewcode-back" href="../../utils/util.html#utils.util.foreground_percentage">[docs]</a><span class="k">def</span> <span class="nf">foreground_percentage</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">class_tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Percentage of pixels that corresponds to the class in the given image.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       mask : 2D Numpy array</span>
<span class="sd">           Image mask to analize.</span>

<span class="sd">       class_tag : int</span>
<span class="sd">           Class to find in the image.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       x : float</span>
<span class="sd">           Percentage of pixels that corresponds to the class. Value between ``0``</span>
<span class="sd">           and ``1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_tag</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">c</span><span class="o">/</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="divide_images_on_classes"><a class="viewcode-back" href="../../utils/util.html#utils.util.divide_images_on_classes">[docs]</a><span class="k">def</span> <span class="nf">divide_images_on_classes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_mask</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a folder for each class where the images that have more pixels labeled as the class (in percentage) than</span>
<span class="sd">       the given threshold will be stored.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data : 4D numpy array</span>
<span class="sd">           Data to save as images. The first dimension must be the number of images. E. g.``(num_of_images, y, x, channels)``.</span>

<span class="sd">       data_mask : 4D numpy array</span>
<span class="sd">           Data mask to save as images.  The first dimension must be the number of images. E. g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       out_dir : str</span>
<span class="sd">           Path to save the images.</span>

<span class="sd">       num_classes : int, optional</span>
<span class="sd">           Number of classes.</span>

<span class="sd">       th : float, optional</span>
<span class="sd">           Percentage of the pixels that must be labeled as a class to save it inside that class folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the directories</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dividing provided data into </span><span class="si">{}</span><span class="s2"> classes . . .&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_classes</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="c1"># Assign the image to a class if it has, in percentage, more pixels of</span>
        <span class="c1"># that class than the given threshold</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">foreground_percentage</span><span class="p">(</span><span class="n">data_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> <span class="s2">&quot;im_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">data_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> <span class="s2">&quot;mask_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="save_filters_of_convlayer"><a class="viewcode-back" href="../../utils/util.html#utils.util.save_filters_of_convlayer">[docs]</a><span class="k">def</span> <span class="nf">save_filters_of_convlayer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">l_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">img_per_row</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an image of the filters learned by a convolutional layer. One can identify the layer with ``l_num`` or</span>
<span class="sd">       ``name`` args. If both are passed ``name`` will be prioritized.</span>

<span class="sd">       Inspired by https://machinelearningmastery.com/how-to-visualize-filters-and-feature-maps-in-convolutional-neural-networks</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       model : Keras Model</span>
<span class="sd">           Model where the layers are stored.</span>

<span class="sd">       out_dir : str</span>
<span class="sd">           Path where the image will be stored.</span>

<span class="sd">       l_num : int, optional</span>
<span class="sd">           Number of the layer to extract filters from.</span>

<span class="sd">       name : str, optional</span>
<span class="sd">           Name of the layer to extract filters from.</span>

<span class="sd">       prefix : str, optional</span>
<span class="sd">           Prefix to add to the output image name.</span>

<span class="sd">       img_per_row : int, optional</span>
<span class="sd">           Filters per row on the image.</span>

<span class="sd">       Raises</span>
<span class="sd">       ------</span>
<span class="sd">       ValueError</span>
<span class="sd">           if ``l_num`` and ``name`` not provided.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       To save the filters learned by the layer called ``conv1`` one can call</span>
<span class="sd">       the function as follows ::</span>

<span class="sd">           save_filters_of_convlayer(model, char_dir, name=&quot;conv1&quot;, prefix=&quot;model&quot;)</span>

<span class="sd">       That will save in ``out_dir`` an image like this:</span>

<span class="sd">       .. image:: ../img/save_filters.png</span>
<span class="sd">           :width: 60%</span>
<span class="sd">           :align: center</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">l_num</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One between &#39;l_num&#39; or &#39;name&#39; must be provided&quot;</span><span class="p">)</span>

    <span class="c1"># For matplotlib errors in display</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>

    <span class="c1"># Find layer number of the layer named by &#39;name&#39; variable</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">l_num</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">l_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>

    <span class="c1"># normalize filter values to 0-1 so we can visualize them</span>
    <span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">filters</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">(</span><span class="n">filters</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_max</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">img_per_row</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img_per_row</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">img_per_row</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">prefix</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">prefix</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;f_layer&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>


<div class="viewcode-block" id="check_masks"><a class="viewcode-back" href="../../utils/util.html#utils.util.check_masks">[docs]</a><span class="k">def</span> <span class="nf">check_masks</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check wheter the data masks have the correct labels inspection a few random images of the given path. If the</span>
<span class="sd">       function gives no error one should assume that the masks are correct.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       path : str</span>
<span class="sd">           Path to the data mask.</span>

<span class="sd">       n_classes : int, optional</span>
<span class="sd">           Maximum classes that the masks must contain.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking wheter the images in </span><span class="si">{}</span><span class="s2"> are binary . . .&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Check only 4 random images or less if there are not as many</span>
    <span class="n">num_sample</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)]</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_sample</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_classes</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: given mask (</span><span class="si">{}</span><span class="s2">) has more classes than specified in &#39;MODEL.N_CLASSES&#39;.&quot;</span>
                             <span class="s2">&quot;That variable value need to be set without counting with background class. &quot;</span> 
                             <span class="s2">&quot; E.g. if mask has [0,1,2] &#39;MODEL.N_CLASSES&#39; should be 2.</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;Values found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">values</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask values need to be consecutive. E.g. [0,1,2,3...]. Provided: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">values</span><span class="p">))</span></div>

<div class="viewcode-block" id="img_to_onehot_encoding"><a class="viewcode-back" href="../../utils/util.html#utils.util.img_to_onehot_encoding">[docs]</a><span class="k">def</span> <span class="nf">img_to_onehot_encoding</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts image given into one-hot encode format.</span>

<span class="sd">       The opposite function is :func:`~onehot_encoding_to_img`.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       img : Numpy 3D/4D array</span>
<span class="sd">           Image. E.g. ``(y, x, channels)`` or ``(z, y, x, channels)``.</span>

<span class="sd">       num_classes : int, optional</span>
<span class="sd">           Number of classes to distinguish.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       one_hot_labels : Numpy 3D/4D array</span>
<span class="sd">           Data one-hot encoded. E.g. ``(y, x, num_classes)`` or ``(z, y, x, num_classes)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,)</span>

    <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">encoded_image</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoded_image</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">encoded_image</span></div>


<div class="viewcode-block" id="onehot_encoding_to_img"><a class="viewcode-back" href="../../utils/util.html#utils.util.onehot_encoding_to_img">[docs]</a><span class="k">def</span> <span class="nf">onehot_encoding_to_img</span><span class="p">(</span><span class="n">encoded_image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts one-hot encode image into an image with jus tone channel and all the classes represented by an integer.</span>

<span class="sd">       The opposite function is :func:`~img_to_onehot_encoding`.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       encoded_image : Numpy 3D/4D array</span>
<span class="sd">           Image. E.g. ``(y, x, channels)`` or ``(z, y, x, channels)``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       img : Numpy 3D/4D array</span>
<span class="sd">           Data one-hot encoded. E.g. ``(z, y, x, num_classes)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">img</span><span class="p">[</span><span class="n">encoded_image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="load_data_from_dir"><a class="viewcode-back" href="../../utils/util.html#utils.util.load_data_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_data_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">return_filenames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">reflect_to_complete_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a directory. If ``crop=False`` all the data is suposed to have the same shape.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str</span>
<span class="sd">           Path to read the data from.</span>

<span class="sd">       crop : bool, optional</span>
<span class="sd">           Crop each image into desired shape pointed by ``crop_shape``.</span>

<span class="sd">       crop_shape : Tuple of 3 ints, optional</span>
<span class="sd">           Shape of the crop to be made. E.g. ``(y, x, channels)``.</span>

<span class="sd">       overlap : Tuple of 2 floats, optional</span>
<span class="sd">           Amount of minimum overlap on x and y dimensions. The values must  be on range ``[0, 1)``, that is, ``0%`` or</span>
<span class="sd">           ``99%`` of overlap. E. g. ``(y, x)``.</span>

<span class="sd">       padding : Tuple of 2 ints, optional</span>
<span class="sd">           Size of padding to be added on each axis ``(y, x)``. E.g. ``(24, 24)``.</span>

<span class="sd">       return_filenames : bool, optional</span>
<span class="sd">           Return a list with the loaded filenames. Useful when you need to save them afterwards with the same names as</span>
<span class="sd">           the original ones.</span>

<span class="sd">       reflect_to_complete_shape : bool, optional</span>
<span class="sd">           Wheter to increase the shape of the dimension that have less size than selected patch size padding it with</span>
<span class="sd">           &#39;reflect&#39;.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       data : 4D Numpy array or list of 3D Numpy arrays</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, y, x, channels)`` if all files have same shape, otherwise a list of</span>
<span class="sd">           ``(y, x, channels)`` arrays will be returned.</span>

<span class="sd">       data_shape : List of tuples</span>
<span class="sd">           Shapes of all 3D images readed. Useful to reconstruct the original images together with ``crop_shape``.</span>

<span class="sd">       crop_shape : List of tuples</span>
<span class="sd">           Shape of the loaded 3D images after cropping. Useful to reconstruct the original images together with</span>
<span class="sd">           ``data_shape``.</span>

<span class="sd">       filenames : List of str, optional</span>
<span class="sd">           Loaded filenames.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>

<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 165 images of shape (1024, 768)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>

<span class="sd">           load_data_from_dir(data_path)</span>
<span class="sd">           # The function will print the shape of the created array. In this example:</span>
<span class="sd">           #     *** Loaded data shape is (165, 768, 1024, 1)</span>
<span class="sd">           # Notice height and width swap because of Numpy ndarray terminology</span>


<span class="sd">           # EXAMPLE 2</span>
<span class="sd">           # Case where we need to load 165 images of shape (1024, 768) but</span>
<span class="sd">           # cropping them into (256, 256, 1) patches</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>
<span class="sd">           crop_shape = (256, 256, 1)</span>

<span class="sd">           load_data_from_dir(data_path, crop=True, crop_shape=crop_shape)</span>
<span class="sd">           # The function will print the shape of the created array. In this example:</span>
<span class="sd">           #     *** Loaded data shape is (1980, 256, 256, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">data.data_2D_manipulation</span> <span class="kn">import</span> <span class="n">crop_data_with_overlap</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c_shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span> <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No images found in dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">id_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span> <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>  

        <span class="k">if</span> <span class="n">reflect_to_complete_shape</span><span class="p">:</span> <span class="n">img</span> <span class="o">=</span> <span class="n">pad_and_reflect</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">crop_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">crop_data_with_overlap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">c_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">crop</span> <span class="ow">or</span> <span class="n">same_shape</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data[0] shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">c_shape</span><span class="p">,</span> <span class="n">filenames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">c_shape</span></div>


<div class="viewcode-block" id="load_ct_data_from_dir"><a class="viewcode-back" href="../../utils/util.html#utils.util.load_ct_data_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_ct_data_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load CT data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str</span>
<span class="sd">           Path to read the data from.</span>

<span class="sd">       shape : 3D int tuple, optional</span>
<span class="sd">           Shape of the data to load. If is not provided the shape is calculated automatically looping over all data</span>
<span class="sd">           files and it will be  the maximum value found per axis. So, given the value the process should be faster.</span>
<span class="sd">           E.g. ``(y, x, channels)``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       data : 4D Numpy array</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>

<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 165 images of shape (1024, 768)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>
<span class="sd">           data_shape = (1024, 768, 1)</span>

<span class="sd">           load_data_from_dir(data_path, data_shape)</span>

<span class="sd">           # The function will print list&#39;s first position array&#39;s shape. In this example:</span>
<span class="sd">           #     *** Loaded data[0] shape is (165, 768, 1024, 1)</span>
<span class="sd">           # Notice height and width swap because of Numpy ndarray terminology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine max in each dimension first</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

            <span class="n">max_x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_x</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_x</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_y</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_y</span>
            <span class="n">max_z</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_z</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_z</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_z</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="c1"># Create the array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="n">_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_3d_images_from_dir"><a class="viewcode-back" href="../../utils/util.html#utils.util.load_3d_images_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_3d_images_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                            <span class="n">median_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reflect_to_complete_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_filenames</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str</span>
<span class="sd">           Path to read the data from.</span>

<span class="sd">       crop : bool, optional</span>
<span class="sd">           Crop each 3D image when readed.</span>

<span class="sd">       crop_shape : Tuple of 4 ints, optional</span>
<span class="sd">           Shape of the subvolumes to create when cropping.  E.g. ``(z, y, x, channels)``.</span>

<span class="sd">       verbose : bool, optional</span>
<span class="sd">           Wheter to enable verbosity.</span>

<span class="sd">       overlap : Tuple of 3 floats, optional</span>
<span class="sd">           Amount of minimum overlap on z, y and x dimensions. The values must be on range ``[0, 1)``, that is, ``0%``</span>
<span class="sd">           or ``99%`` of overlap. E.g. ``(z, y, x)``.</span>

<span class="sd">       padding : Tuple of 3 ints, optional</span>
<span class="sd">           Size of padding to be added on each axis ``(z, y, x)``. E.g. ``(24, 24, 24)``.</span>

<span class="sd">       median_padding : bool, optional</span>
<span class="sd">           If ``True`` the padding value is the median value. If ``False``, the added values are zeroes.</span>

<span class="sd">       reflect_to_complete_shape : bool, optional</span>
<span class="sd">           Wheter to increase the shape of the dimension that have less size than selected patch size padding it with</span>
<span class="sd">           &#39;reflect&#39;.</span>

<span class="sd">       return_filenames : bool, optional</span>
<span class="sd">           Return a list with the loaded filenames. Useful when you need to save them afterwards with the same names as</span>
<span class="sd">           the original ones.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       data : 5D Numpy array or list of 4D Numpy arrays</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, z, y, x, channels)`` if all files have same shape, otherwise a list of</span>
<span class="sd">           ``(1, z, y, x, channels)`` arrays will be returned.</span>

<span class="sd">       data_shape : List of tuples</span>
<span class="sd">           Shapes of all 3D images readed. Useful to reconstruct the original images together with ``crop_shape``.</span>

<span class="sd">       crop_shape : List of tuples</span>
<span class="sd">           Shape of the loaded 3D images after cropping. Useful to reconstruct the original images together with</span>
<span class="sd">           ``data_shape``.</span>

<span class="sd">       filenames : List of str, optional</span>
<span class="sd">           Loaded filenames.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>

<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 20 images of shape (1024, 1024, 91, 1)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>

<span class="sd">           data = load_data_from_dir(data_path)</span>
<span class="sd">           # The function will print list&#39;s first position array&#39;s shape. In this example:</span>
<span class="sd">           #     *** Loaded data[0] shape is (20, 91, 1024, 1024, 1)</span>
<span class="sd">           # Notice height, width and depth swap as skimage.io imread function</span>
<span class="sd">           # is used to load images</span>

<span class="sd">           # EXAMPLE 2</span>
<span class="sd">           # Same as example 1 but with unknown shape, cropping them into (256, 256, 40, 1) subvolumes with minimum</span>
<span class="sd">           # overlap and storing filenames.</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>

<span class="sd">           X_test, orig_test_img_shapes, \</span>
<span class="sd">           crop_test_img_shapes, te_filenames = load_3d_images_from_dir(</span>
<span class="sd">               test_path, crop=True, crop_shape=(256, 256, 40, 1), overlap=(0,0,0), return_filenames=True)</span>

<span class="sd">           # The function will print the shape of the created array which its size is the concatenation in 0 axis of all</span>
<span class="sd">           # subvolumes created for each 3D image in the given path. For example:</span>
<span class="sd">           #     *** Loaded data shape is (350, 40, 256, 256, 1)</span>
<span class="sd">           # Notice height, width and depth swap as skimage.io imread function is used to load images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="n">crop_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;crop_shape&#39; must be provided when &#39;crop&#39; is True&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No images found in dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">data.data_3D_manipulation</span> <span class="kn">import</span> <span class="n">crop_3D_data_with_overlap</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c_shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span> <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Read images</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">id_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Read image seems to be 2D: </span><span class="si">{}</span><span class="s2">. Path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span> <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reflect_to_complete_shape</span><span class="p">:</span> <span class="n">img</span> <span class="o">=</span> <span class="n">pad_and_reflect</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">crop_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">crop_3D_data_with_overlap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
                                            <span class="n">median_padding</span><span class="o">=</span><span class="n">median_padding</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">c_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data type mismatch </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> found in the dataset. Please check it and ensure all&quot;</span>
                             <span class="s2">&quot; images have same data type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">crop</span> <span class="ow">or</span> <span class="n">same_shape</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data[0] shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">c_shape</span><span class="p">,</span> <span class="n">filenames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">c_shape</span></div>


<div class="viewcode-block" id="check_downsample_division"><a class="viewcode-back" href="../../utils/util.html#utils.util.check_downsample_division">[docs]</a><span class="k">def</span> <span class="nf">check_downsample_division</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">d_levels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures ``X`` shape is divisible by ``2`` times ``d_levels`` adding padding if necessary.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D Numpy array</span>
<span class="sd">           Data to check if its shape.  E.g. ``(10, 1000, 1000, 1)``.</span>

<span class="sd">       d_levels : int</span>
<span class="sd">           Levels of downsampling by ``2``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       X : 4D Numpy array</span>
<span class="sd">           Data divisible by 2 ``d_levels`` times.</span>

<span class="sd">       o_shape : 4 int tuple</span>
<span class="sd">           Original shape of ``X``. E.g. ``(10, 1000, 1000, 1)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">d_val</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">d_levels</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">d_val</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">d_val</span><span class="p">)</span>
    <span class="n">o_shape</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">dy</span><span class="o">*</span><span class="n">d_val</span> <span class="o">!=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dx</span><span class="o">*</span><span class="n">d_val</span> <span class="o">!=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">dy</span><span class="o">*</span><span class="n">d_val</span><span class="p">)</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">dx</span><span class="o">*</span><span class="n">d_val</span><span class="p">)</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data has been padded to be downsampled </span><span class="si">{}</span><span class="s2"> times. Its shape now is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_levels</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">o_shape</span></div>


<div class="viewcode-block" id="save_npy_files"><a class="viewcode-back" href="../../utils/util.html#utils.util.save_npy_files">[docs]</a><span class="k">def</span> <span class="nf">save_npy_files</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save images in the given directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D/5D numpy array</span>
<span class="sd">           Data to save as images. The first dimension must be the number of images. E.g.</span>
<span class="sd">           ``(num_of_images, y, x, channels)`` or ``(num_of_images, z, y, x, channels)``.</span>

<span class="sd">       data_dir : str, optional</span>
<span class="sd">           Path to store X images.</span>

<span class="sd">       filenames : List, optional</span>
<span class="sd">           Filenames that should be used when saving each image.</span>

<span class="sd">       verbose : bool, optional</span>
<span class="sd">            To print saving information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">{}</span><span class="s2"> data as .npy in folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filenames array and length of X have different shapes: </span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="pad_and_reflect"><a class="viewcode-back" href="../../utils/util.html#utils.util.pad_and_reflect">[docs]</a><span class="k">def</span> <span class="nf">pad_and_reflect</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       img : 3D/4D Numpy array</span>
<span class="sd">           Image to pad. E.g. ``(y, x, channels)`` or ``(z, y, x, c)``.</span>

<span class="sd">       crop_shape : Tuple of 3/4 ints, optional</span>
<span class="sd">           Shape of the subvolumes to create when cropping.  E.g. ``(y, x, channels)`` or ``(z, y, x, channels)``.</span>

<span class="sd">       verbose : bool, optional</span>
<span class="sd">           Wheter to output information.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       img : 3D/4D Numpy array</span>
<span class="sd">           Image padded (if needed). E.g. ``(y, x, channels)`` or ``(z, y, x, channels)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">crop_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;crop_shape&#39; needs to have 4 values as the input array has 4 dims&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">crop_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;crop_shape&#39; needs to have 3 values as the input array has 3 dims&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">o_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">((</span><span class="n">diff</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reflected from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_shape</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">o_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">diff</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reflected from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_shape</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">o_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">diff</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reflected from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_shape</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">o_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">((</span><span class="n">diff</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reflected from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_shape</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crop_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">o_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">diff</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reflected from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_shape</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="wrapper_matching_dataset_lazy"><a class="viewcode-back" href="../../utils/util.html#utils.util.wrapper_matching_dataset_lazy">[docs]</a><span class="k">def</span> <span class="nf">wrapper_matching_dataset_lazy</span><span class="p">(</span><span class="n">stats_all</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;iou&#39;</span><span class="p">,</span> <span class="n">by_image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">expected_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s1">&#39;fp&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;fn&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;criterion&#39;</span><span class="p">,</span> <span class="s1">&#39;thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;n_true&#39;</span><span class="p">,</span> <span class="s1">&#39;n_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_true_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_matched_score&#39;</span><span class="p">,</span> <span class="s1">&#39;panoptic_quality&#39;</span><span class="p">))</span>

    <span class="c1"># accumulate results over all images for each threshold separately</span>
    <span class="n">n_images</span><span class="p">,</span> <span class="n">n_threshs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_all</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>

    <span class="n">single_thresh</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">n_threshs</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">accumulate</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_threshs</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">stats_all</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">accumulate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;mean_true_score&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">by_image</span><span class="p">):</span>
                    <span class="c1"># convert mean_true_score to &quot;sum_matched_score&quot;</span>
                    <span class="n">acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">n_true</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">pass</span>

    <span class="c1"># normalize/compute &#39;precision&#39;, &#39;recall&#39;, &#39;accuracy&#39;, &#39;f1&#39;</span>
    <span class="k">for</span> <span class="n">thr</span><span class="p">,</span><span class="n">acc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span><span class="n">accumulate</span><span class="p">):</span>
        <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;criterion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criterion</span>
        <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thr</span>
        <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;by_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">by_image</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">by_image</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_true_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_matched_score&#39;</span><span class="p">,</span> <span class="s1">&#39;panoptic_quality&#39;</span><span class="p">):</span>
                <span class="n">acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">n_images</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">n_true</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;tp&#39;</span><span class="p">],</span> <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">],</span> <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">],</span> <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;n_true&#39;</span><span class="p">]</span>
            <span class="n">sum_matched_score</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="s1">&#39;mean_true_score&#39;</span><span class="p">]</span>

            <span class="n">mean_matched_score</span> <span class="o">=</span> <span class="n">_safe_divide</span><span class="p">(</span><span class="n">sum_matched_score</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
            <span class="n">mean_true_score</span>    <span class="o">=</span> <span class="n">_safe_divide</span><span class="p">(</span><span class="n">sum_matched_score</span><span class="p">,</span> <span class="n">n_true</span><span class="p">)</span>
            <span class="n">panoptic_quality</span>   <span class="o">=</span> <span class="n">_safe_divide</span><span class="p">(</span><span class="n">sum_matched_score</span><span class="p">,</span> <span class="n">tp</span><span class="o">+</span><span class="n">fp</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">fn</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">acc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">precision</span>          <span class="o">=</span> <span class="n">precision</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">fn</span><span class="p">),</span>
                <span class="n">recall</span>             <span class="o">=</span> <span class="n">recall</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">fn</span><span class="p">),</span>
                <span class="n">accuracy</span>           <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">fn</span><span class="p">),</span>
                <span class="n">f1</span>                 <span class="o">=</span> <span class="n">f1</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">fn</span><span class="p">),</span>
                <span class="n">mean_true_score</span>    <span class="o">=</span> <span class="n">mean_true_score</span><span class="p">,</span>
                <span class="n">mean_matched_score</span> <span class="o">=</span> <span class="n">mean_matched_score</span><span class="p">,</span>
                <span class="n">panoptic_quality</span>   <span class="o">=</span> <span class="n">panoptic_quality</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">accumulate</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DatasetMatching&#39;</span><span class="p">,</span><span class="n">acc</span><span class="o">.</span><span class="n">keys</span><span class="p">())(</span><span class="o">*</span><span class="n">acc</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accumulate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accumulate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single_thresh</span> <span class="k">else</span> <span class="n">accumulate</span></div>

<div class="viewcode-block" id="wrapper_matching_segCompare"><a class="viewcode-back" href="../../utils/util.html#utils.util.wrapper_matching_segCompare">[docs]</a><span class="k">def</span> <span class="nf">wrapper_matching_segCompare</span><span class="p">(</span><span class="n">stats_all</span><span class="p">):</span>
    <span class="n">expected_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number_of_cells&#39;</span><span class="p">,</span> <span class="s1">&#39;correct_segmentations&#39;</span><span class="p">,</span> <span class="s1">&#39;oversegmentation_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;undersegmentation_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;missing_rate&#39;</span><span class="p">]</span>

    <span class="n">accumulated_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">expected_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_all</span><span class="p">:</span>
            <span class="n">accumulated_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">accumulated_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">stat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">accumulated_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">accumulated_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_all</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accumulated_values</span></div>
    
<div class="viewcode-block" id="check_value"><a class="viewcode-back" href="../../utils/util.html#utils.util.check_value">[docs]</a><span class="k">def</span> <span class="nf">check_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Checks if a value is within a range &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">value_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>    
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span> 
    <span class="k">else</span><span class="p">:</span>   
        <span class="k">if</span> <span class="n">value_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">value_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Daniel Franco-Barranco.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>